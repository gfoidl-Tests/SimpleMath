jobs:
  - job: deploy_package
    pool:
      vmImage: 'ubuntu-18.04'
    steps:
      - checkout: none

      - task: DownloadPipelineArtifact@2
        inputs:
          artifactName: drop
          targetPath: ./tmp

      - bash: |
          ls -la tmp
          echo ""

          if [[ "$TAG_NAME" =~ ^v([0-9]+)\.([0-9]+)\.([0-9]+)(-(preview-[0-9]+))$ ]]; then
              mkdir deploy_custom
              mv tmp/* deploy_custom

              # update version in package.json -- cut off the v-prefix in the TAG_NAME
              cd deploy_custom
              yarn version --new-version ${TAG_NAME#v}
              cd -

              echo "##vso[task.setvariable variable=deploy_custom;]1"
          elif [[ "$TAG_NAME" =~ ^v([0-9]+)\.([0-9]+)\.([0-9]+)$ ]]; then
              mkdir deploy_npm
              mv tmp/* deploy_npm

              # update version in package.json -- cut off the v-prefix in the TAG_NAME
              cd deploy_npm
              yarn version --new-version ${TAG_NAME#v}
              cd -

              echo "##vso[task.setvariable variable=deploy_npm;]1"
          else
              echo "no deploy, as '$TAG_NAME' does not match"
              echo "##vso[task.complete result=SucceededWithIssues;]tag does not match for deploy"
          fi

          echo "-------------------------------------------------"
          echo "custom:"
          ls -la deploy_custom
          echo "-------------------------------------------------"
          echo "npm:"
          ls -la deploy_npm
          echo "-------------------------------------------------"
        displayName: deploy to npm or local feed

      - task: Npm@1
        condition: eq(variables['deploy_custom'], '1')
        inputs:
          command: publish
          workingDir: deploy_custom
          publishRegistry: useFeed
          publishFeed: 'b917ef97-c76f-4ce5-a20e-a2eb342180cb/28f55dcf-f579-4358-a296-0a62ccffd4c1'
        displayName: deploy to custom feed

      - task: Npm@1
        condition: eq(variables['deploy_npm'], '1')
        inputs:
          command: publish
          workingDir: deploy_npm
          publishEndpoint: npm      # service connection defined in Azure DevOps UI
        displayName: deploy to npm
