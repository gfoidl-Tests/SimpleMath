jobs:
  - job: deploy_package
    pool:
      vmImage: 'ubuntu-18.04'
    steps:
      - checkout: none

      - task: DownloadPipelineArtifact@2
        inputs:
          artifactName: drop
          targetPath: ./tmp

      - bash: |
          ls -la

          if [[ "$TAG_NAME" =~ ^v([0-9]+)\.([0-9]+)\.([0-9]+)(-(preview-[0-9]+))$ ]]; then
            mkdir deploy_custom
            mv tmp deploy_custom
          elif [[ "$TAG_NAME" =~ ^v([0-9]+)\.([0-9]+)\.([0-9]+)$ ]]; then
            mkdir deploy_npm
            mv tmp deploy_npm
          else
            echo "no deploy, as $TAG_NAME does not match"
            echo ##vso[task.complete result=Skipped;]tag does not match for deploy
          fi

          echo "-------------------------------------------------"
          echo "custom:"
          ls -la deploy_custom
          echo "-------------------------------------------------"
          echo "npm:"
          ls -la deploy_npm
          echo "-------------------------------------------------"
        displayName: deploy to npm or local feed

      - task: Npm@1
        inputs:
          command: publish
          workingDir: deploy_custom
          publishRegistry: useFeed
          publishFeed: 'b917ef97-c76f-4ce5-a20e-a2eb342180cb/28f55dcf-f579-4358-a296-0a62ccffd4c1'

      - task: Npm@1
        inputs:
          command: publish
          workingDir: deploy_npm
          publishEndpoint: npm      # service connection defined in Azure DevOps UI
